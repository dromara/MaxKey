/*
 * Selecter Plugin [Formstone Library]
 * @author Ben Plum
 * @version 2.1.4
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(f){function v(a){a=f.extend({},w,a||{});for(var b=f(this),e=0,d=b.length;e<d;e++){var h=b.eq(e),g=a;if(!h.data("selecter")){g.externalLinks&&(g.links=!0);f.extend(g,h.data("selecter-options"));var k=h.find("option, optgroup"),n=k.filter("option"),l=n.filter(":selected"),t=g.defaultLabel?-1:n.index(l),u=k.length-1,s=g.links?"nav":"div",x=g.links?"a":"span";g.multiple=h.prop("multiple");g.disabled=h.is(":disabled");var c="<"+s+' class="selecter '+g.customClass;m?c+=" mobile":g.cover&&(c+= " cover");c=g.multiple?c+" multiple":c+" closed";g.disabled&&(c+=" disabled");c+='">';g.multiple||(c+='<span class="selecter-selected">',c+=y(g.trimOptions,!1!=g.defaultLabel?g.defaultLabel:l.text()),c+="</span>");for(var c=c+'<div class="selecter-options">',l=0,p=null,q=0,v=k.length;q<v;q++)p=f(k[q]),"OPTGROUP"==p[0].tagName?c+='<span class="selecter-group">'+p.attr("label")+"</span>":(c+="<"+x+' class="selecter-item',p.is(":selected")&&!g.defaultLabel&&(c+=" selected"),0==q&&(c+=" first"),q==u&& (c+=" last"),c+='" ',c=g.links?c+('href="'+p.val()+'"'):c+('data-value="'+p.val()+'"'),c+=">"+y(g.trimOptions,p.text())+"</"+x+">",l++);c+="</div>";c+="</"+s+">";h.addClass("selecter-element").after(c);k=h.next(".selecter");g=f.extend({$selectEl:h,$optionEls:n,$selecter:k,$selected:k.find(".selecter-selected"),$itemsWrapper:k.find(".selecter-options"),$items:k.find(".selecter-item"),index:t,guid:z},g);void 0!=f.fn.scroller&&g.$itemsWrapper.scroller();k.on("click.selecter",".selecter-selected",g,A).on("click.selecter", ".selecter-item",g,B).on("selecter-close",g,r).data("selecter",g);if(!g.links&&!m||m){if(h.on("change",g,C).on("blur.selecter",g,D),!m)h.on("focus.selecter",g,E)}else h.hide();z++}}return b}function A(a){a.preventDefault();a.stopPropagation();var b=a.data;if(!b.$selectEl.is(":disabled"))if(f(".selecter").not(b.$selecter).trigger("selecter-close",[b]),m)a=b.$selectEl[0],document.createEvent?(b=document.createEvent("MouseEvents"),b.initMouseEvent("mousedown",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null), a.dispatchEvent(b)):element.fireEvent&&a.fireEvent("onmousedown");else if(b.$selecter.hasClass("closed")){if(a.preventDefault(),a.stopPropagation(),a=a.data,!a.$selecter.hasClass("open")){var b=a.$selecter.offset(),e=f("body").outerHeight(),d=a.$itemsWrapper.outerHeight(!0);b.top+d>e&&m?a.$selecter.addClass("bottom"):a.$selecter.removeClass("bottom");a.$itemsWrapper.show();a.$selecter.removeClass("closed").addClass("open");f("body").on("click.selecter-"+a.guid,":not(.selecter-options)",a,F).on("keydown.selecter-"+ a.guid,a,t);void 0!=f.fn.scroller&&a.$itemsWrapper.scroller("reset")}}else b.$selecter.hasClass("open")&&r(a)}function r(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selecter.hasClass("open")&&(a.$itemsWrapper.hide(),a.$selecter.removeClass("open").addClass("closed"),f("body").off(".selecter-"+a.guid))}function F(a){a.preventDefault();a.stopPropagation();0==f(a.currentTarget).parents(".selecter").length&&r(a)}function B(a){a.preventDefault();a.stopPropagation();var b=f(this),e=a.data;e.$selectEl.is(":disabled")|| (e.$itemsWrapper.is(":visible")&&(b=e.$items.index(b),n(b,e,!1)),e.multiple||r(a))}function C(a,b){if(!b){var e=f(this),d=a.data;d.links?m?l(e.val(),d.externalLinks):l(e.attr("href"),d.externalLinks):(e=d.$optionEls.index(d.$optionEls.filter("[value="+e.val()+"]")),n(e,d,!1))}}function E(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selectEl.is(":disabled")||a.multiple||(a.$selecter.addClass("focus"),f(".selecter").not(a.$selecter).trigger("selecter-close",[a]),f("body").on("keydown.selecter-"+ a.guid,a,t))}function D(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selecter.removeClass("focus");f(".selecter").not(a.$selecter).trigger("selecter-close",[a]);f("body").off(".selecter-"+a.guid)}function t(a){var b=a.data;if(b.$selecter.hasClass("open")&&13==a.keyCode)n(b.index,b,!1),r(a);else if(9!=a.keyCode&&!(a.metaKey||a.altKey||a.ctrlKey||a.shiftKey)){a.preventDefault();a.stopPropagation();var e=b.$items.length-1,d=-1;if(-1<f.inArray(a.keyCode,u?[38,40,37,39]:[38,40]))d=b.index+(38== a.keyCode||u&&37==a.keyCode?-1:1),0>d&&(d=0),d>e&&(d=e);else{a=String.fromCharCode(a.keyCode).toUpperCase();for(i=b.index+1;i<=e;i++){var h=b.$optionEls.eq(i).text().charAt(0).toUpperCase();if(h==a){d=i;break}}if(0>d)for(i=0;i<=e;i++)if(h=b.$optionEls.eq(i).text().charAt(0).toUpperCase(),h==a){d=i;break}}0<=d&&n(d,b,!0)}}function n(a,b,e){var d=b.$items.eq(a),f=d.hasClass("selected");if(f)b.multiple&&(b.$optionEls.eq(a).prop("selected",null),d.removeClass("selected"));else{var g=d.html();d.data("value"); if(b.multiple)b.$optionEls.eq(a).prop("selected",!0);else if(b.$selected.html(g),b.$items.filter(".selected").removeClass("selected"),e||(b.$selectEl[0].selectedIndex=a),b.links&&!e){m?l(b.$selectEl.val(),b.externalLinks):l(d.attr("href"),b.externalLinks);return}b.$selectEl.trigger("change",[!0]);d.addClass("selected")}if(!f||b.multiple)b.callback.call(b.$selecter,b.$selectEl.val(),a),b.index=a}function y(a,b){return!1===a?b:b.length>a?b.substring(0,a)+"...":b}function l(a,b){b?window.open(a):window.location.href= a}var u=-1<navigator.userAgent.toLowerCase().indexOf("firefox"),m=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent||navigator.vendor||window.opera),w={callback:function(){},cover:!1,customClass:"",defaultLabel:!1,externalLinks:!1,links:!1,trimOptions:!1},z=0,s={defaults:function(a){w=f.extend(w,a||{});return f(this)},disable:function(){return f(this).each(function(a,b){var e=f(b),d=e.next(".selecter");d.hasClass("open")&&d.find(".selecter-selected").trigger("click");e.prop("disabled", !0);d.addClass("disabled")})},enable:function(){return f(this).each(function(a,b){var e=f(b),d=e.next(".selecter");e.prop("disabled",null);d.removeClass("disabled")})},destroy:function(){return f(this).each(function(a,b){var e=f(b),d=e.next(".selecter");d.hasClass("open")&&d.find(".selecter-selected").trigger("click");void 0!=f.fn.scroller&&d.find(".selecter-options").scroller("destroy");e.off(".selecter").removeClass("selecter-element").show();d.off(".selecter").remove()})}};f.fn.selecter=function(a){return s[a]? s[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:v.apply(this,arguments)}})(jQuery);